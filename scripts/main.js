function TimelineGraph(t,e){var a=this;this.element=d3.select(t),this.datasets=[];var r=2010,n=2007,i=2015,s=[n,i-1],l=30,o=this.element.node().getBoundingClientRect().width,c={top:20,right:20,bottom:30,left:50},h=o-c.left-c.right,p=200-c.top-c.bottom+l;this.height=p,this.width=h,this.xScale=d3.scale.linear().domain(s).range([0,h]);var u=this.xScale;this.element.select("select").on("change",function(){var t=parseInt(a.element.select("select").node().value);a.graphs[t].element.attr("opacity",1),a.graphs[(t+1)%2].element.attr("opacity",0)});var f=d3.svg.axis().scale(u).tickPadding(l).tickFormat(d3.format("d")).orient("bottom");this.svg=this.element.select("#chart").append("svg").attr("width",h+c.left+c.right).attr("height",p+c.top+c.bottom+l).append("g").attr("transform","translate("+c.left+","+c.top+")"),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+p+")").call(f);var m=this.svg.append("g"),v=p+20;m.append("line").attr("x1",0).attr("x2",h).attr("y1",v).attr("y2",v).attr("class","year-selector").style("stroke","black");var y=u(r),g=this.svg.append("line").attr("class","focus-line current").attr("x1",y).attr("x2",y).attr("y1",0).attr("y2",p+l/4);m.append("g").selectAll("circle").data(d3.range(n,i)).enter().append("circle").attr("class","year-bullet").classed("selected",function(t){return t==r}).attr("cx",function(t){return u(t)}).attr("cy",v).attr("r",8).on("click",function(t,e){var a=u(t);g.attr("x1",a).attr("x2",a).attr("y1",0),d3.select("#chart").selectAll(".year-bullet").classed("selected",function(t,a){return e==a})}),this.tip=d3.tip().attr("class","d3-tip").offset([-10,50]).html(function(t){return JSON.stringify(t)}),this.svg.call(this.tip),this.focusLine=this.svg.append("line").attr("class","focus-line").attr("x1",5).attr("y1",0).attr("x2",50).attr("y2",p+l/4).style("opacity",0),this.highestValueForYear=function(t){var e=_.filter(_.flatten(a.datasets),function(e){return console.log(e),e.year==t});return _.max(e,function(){return d.number})};var x=["number","relative"];this.graphs=_.map(["absolute-chart","relative-chart"],function(t,e){var r=new LineGraph(a,t,x[e]);return r}),this.graphs[1].element.attr("opacity",0)}function LineGraph(t,e,a){this.parent=t,this.element=t.svg.append("g").attr("id",e);d3.scale.linear().range([t.height,0]);this.valueKey=a}function type(t){return t.year=+t.year,t.number=+t.number,t}var ColorProvider={maps:{},availableColors:["#31a354","orange","steelblue"],colorForKey:function(t){if(!this.maps[t]){var e=this.availableColors.pop();this.maps[t]=e}return this.maps[t]},releaseColor:function(t){var e=this.maps[t];e&&(this.availableColors.push(e),delete this.maps[t])}};TimelineGraph.prototype.addData=function(t){var e=this,a=t[0].country;if(_.find(e.datasets,function(t){return t[0].country==a}))return void console.log("country in the list already");_.each(t,function(e,a){if(0==a)e.relative=0;else{var r=t[a-1];e.relative=(e.number-r.number)/r.number}});var r=this.element,n=(this.datasets.length,r.select("ul").append("li").attr("class","legend").html(function(t){return"<li><span>‚óè</span>"+a+' <span class="close">[x]</span></li>'}));n.select("span.close").on("click",function(){e.removeData(a),n.remove()}),n.select("span").style("color",ColorProvider.colorForKey(a)),this.datasets.push(t),this.render()},TimelineGraph.prototype.removeData=function(t){var e=_.findIndex(this.datasets,function(e){return t==e[0].country});this.datasets.splice(e,1),this.render()},TimelineGraph.prototype.render=function(){var t=this;_.each(this.graphs,function(e){e.render(t.datasets)})},LineGraph.prototype.render=function(t){this.element.selectAll("*").remove();var e=this.parent.tip,a=this.parent.xScale,r=d3.scale.linear().range([this.parent.height,0]),n=this.parent.focusLine,i=this.valueKey,s=_.flatten(t),l=_.maxBy(s,i);if(l){var o=[0,l[i]];if("relative"==i){var c=_.minBy(s,i),h=_.map([l[i],c[i]],function(t){return Math.abs(t)}),p=_.max(h);o=[-p,p]}r.domain(o);var u=d3.format(".2s");"relative"==i&&(u=d3.format("1.1f"));var d=d3.svg.axis().scale(r).ticks(5).tickFormat(u).orient("left"),f=d3.svg.line().x(function(t){return a(t.year)}).y(function(t){return r(t[i])});this.element.append("g").attr("class","y axis").attr("transform","translate(-20,0)").call(d).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em"),this.element.selectAll(".country").data(t).enter().append("path").attr("class","line").attr("stroke",function(t){return ColorProvider.colorForKey(t[0].country)}).attr("d",f),"relative"==i&&this.element.append("line").attr("x1",0).attr("x2",this.parent.width).attr("y1",r(0)).attr("y2",r(0)).attr("stroke","black").attr("opacity",.2),this.element.append("g").attr("class","line-point").selectAll("circle").data(s).enter().append("circle").attr("cx",function(t){return a(t.year)}).attr("cy",function(t,e){return r(t[i])}).attr("r",5).style("fill",function(t){return ColorProvider.colorForKey(t.country)}).on("mouseover",function(t,l){var o=_.filter(s,function(e){return e.year==t.year});e.show(o);var c=_.max(o,function(t){return t[i]}),h=a(t.year),p=r(c[i]);n.attr("x1",h).attr("x2",h).attr("y1",p).style("opacity",.7)}).on("mouseout",function(t){e.hide(t),n.style("opacity",0)})}};var datasets=[[],[]],timeline=new TimelineGraph("#timeline-panel");d3.tsv("data.tsv",type,function(t,e){if(t)throw t;for(var a=0;a<e.length;a++){var r=0;"India"==e[a].country&&(r=1),datasets[r].push(e[a])}timeline.addData(datasets[0]),console.log(datasets[0])});